@page
@using Newtonsoft.Json;
@model Hik.Web.Pages.TriggerModel
@{

    @if (!string.IsNullOrEmpty(Model.Dto.Name))
    {
        ViewData["Title"] = $"Edit {Model.Dto.Name}";
    }
    else
    {
        ViewData["Title"] = "New trigger";
    }
}

@{
    var title = $"{@Model.Dto.Group}.{@Model.Dto.Name}";
    <div class="row">
                <div class="card-body text-center">
                    <h2 class="card-title">@title</h2>
                </div>
    </div>
}
<div>
    <a asp-page="./Scheduler">Back to List</a>
</div>
<hr />
<div class="row">
    <div class="col-md-4">
        <form method="post" id="myForm">

            <div class="form-group">
                <input type="submit" value="Save" class="btn btn-primary" />
            </div>

            <div class="form-group">
                <label asp-for="Dto.ClassName" class="control-label"></label>
                @Html.DropDownListFor(x => Model.Dto.ClassName, TriggerModel.JobTypesList, "", new { @class = "form-control", @id = "ddlFruits" })
            </div>

            <div id="selectTableContainer">
                @if (!string.IsNullOrEmpty(Model.Dto.ClassName))
                {
                   @if (Model.Dto.ClassName == "ArchiveJob")
                   {
                       @* @await Html.PartialAsync("Shared/_ArchiveJob.cshtml", Model) *@
                        <partial name="_ArchiveJob" model="Model" />
                   }
                   else if (Model.Dto.ClassName == "GarbageCollectorJob")
                   {
                       @*  @await Html.PartialAsync("Shared/_GCJob.cshtml", Model) *@
                        <partial name="_GCJob" model="Model" />
                   }else
                   {
                       @*  @await Html.PartialAsync("Shared/_CameraJob.cshtml", Model) *@
                        <partial name="_CameraJob" model="Model" />
                   }
                }
            </div>
    </form>
    </div>
</div>

@section Scripts
{
<script type="text/javascript">
    $("body").on("change", "#ddlFruits", function () {
        var t = $(this).find("option:selected").text();
        var url = "/Trigger?classid=" + $(this).val() + "&handler=ConfigView";

        var requestData = { Dto: @Html.Raw(JsonConvert.SerializeObject(Model.Dto))};

        // Serialize the request data
        var serializedModel = JSON.stringify(requestData);

        $.ajax({
            url: url,
            method: "POST",
            contentType: "application/json; charset=utf-8",
            headers: {
                RequestVerificationToken:
                    $('input:hidden[name="__RequestVerificationToken"]').val()
            },
            data: serializedModel,
            success: function (result) {
                    $("#selectTableContainer").html(result);
            },
            error: function () {
                alert("Failed.");
            }
        });
    });



        $(document).ready(function () {
            $("#myForm").submit(function (e) {
                e.preventDefault(); // Prevent the default form submission

                var requestData = @Html.Raw(JsonConvert.SerializeObject(Model.Dto));

                $.ajax({
                    url: "/Trigger?handler=Submit",
                    type: "POST",
                    data: JSON.stringify(requestData),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    headers: {
                        RequestVerificationToken:
                            $('input:hidden[name="__RequestVerificationToken"]').val()
                    },
                    success: function (result) {
                        if (result.success) {
                            alert(result.message);
                        } else {
                            alert("An error occurred.");
                        }
                    }
                });
            });
        });

</script>
}